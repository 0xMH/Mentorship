events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;

    # Upstream application server
    upstream app_server {
        server app:5000;  # Flask/Gunicorn running in the 'app' container
    }

    # HTTP -> HTTPS redirect (first 301)
    server {
        listen 80;
        server_name example.com www.example.com;

        return 301 https://$host$request_uri;
    }

    # --------------------------------------------------------------------------
    # Facebook-style dynamic redirect (commented for reference)
    # --------------------------------------------------------------------------
    # Facebook redirects to HTTPS using whatever Host header the client sends:
    #   curl -I --header 'Host: Hamza.com' facebook.com
    #   -> Location: https://Hamza.com/
    #
    # To mimic this behavior, use $host instead of a hardcoded domain:
    #
    # server {
    #     listen 80 default_server;
    #     server_name _;                          # catch-all for any Host header
    #
    #     return 301 https://$host$request_uri;   # redirect to whatever Host was sent
    # }
    #
    # Note: $host = value of the Host header sent by the client
    # This is useful for multi-tenant setups or wildcard domains
    # --------------------------------------------------------------------------

    # HTTPS non-www -> www redirect (second 301)
    server {
        listen 443 ssl;
        server_name example.com;

        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        return 301 https://www.example.com$request_uri;
    }

    # HTTPS www - final destination
    server {
        listen 443 ssl;
        server_name www.example.com;

        ssl_certificate /etc/nginx/certs/server.crt;
        ssl_certificate_key /etc/nginx/certs/server.key;

        # Security headers
        add_header Strict-Transport-Security "max-age=15552000; preload" always;
        add_header X-Content-Type-Options "nosniff" always;
        add_header X-Frame-Options "DENY" always;

        # Static files - served directly by NGINX (Web Server)
        location /static/ {
            alias /usr/share/nginx/html/static/;
            expires 30d;
            add_header X-Served-By "NGINX (Web Server)" always;
        }

        # Everything else -> proxy to Application Server
        location / {
            proxy_pass http://app_server;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # Header to show this came through nginx
            add_header X-Proxied-By "NGINX (Web Server)" always;
        }
    }
}
